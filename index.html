<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>F1 Grand Prix - Full Simulation</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .panel { width: 350px; background: rgba(15, 15, 15, 0.98); border: 2px solid #e10600; color: white; padding: 25px; pointer-events: all; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #hud { position: absolute; top: 20px; left: 20px; width: 220px; display: none; pointer-events: none; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: #aaa; }
        .stat-val { font-size: 18px; font-weight: bold; }
        #lights-container { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); background: #111; padding: 15px; border-radius: 10px; display: none; border: 4px solid #333; z-index: 100; }
        .light-row { display: flex; gap: 15px; }
        .bulb { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .bulb.red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        button { width: 100%; background: #e10600; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; border-radius: 4px; }
        label { display: block; margin-top: 12px; font-size: 12px; color: #aaa; }
        select, input { width: 100%; padding: 12px; margin: 5px 0 10px 0; background: #222; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        #results-screen { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: all; }
    </style>
</head>
<body>

    <div id="results-screen">
        <h1 style="color: #e10600">CORRIDA ENCERRADA</h1>
        <div id="podium" style="background: #222; padding: 20px; border-radius: 10px; width: 300px; text-align: center;"></div>
        <button onclick="location.reload()">NOVA CORRIDA</button>
    </div>

    <div id="ui-layer">
        <div class="panel">
            <h2 style="color: #e10600; text-align: center;">F1 GP SETUP</h2>
            <label>NOME DO PILOTO:</label><input type="text" id="playerName" placeholder="Senna">
            <label>EQUIPE:</label><select id="teamSelect"></select>
            <label>VOLTAS:</label>
            <select id="lapLimit"><option value="1">1 Volta</option><option value="3" selected>3 Voltas</option><option value="5">5 Voltas</option></select>
            <button onclick="startGame()">IR PARA A PISTA</button>
        </div>
    </div>

    <div id="hud" class="panel">
        <div class="stat-row">
            <div><div class="stat-label">POS</div><div class="stat-val" id="posTxt">1</div></div>
            <div style="text-align: right"><div class="stat-label">VOLTA</div><div class="stat-val"><span id="lapTxt">1</span>/<span id="totalLapTxt">3</span></div></div>
        </div>
        <div class="stat-row" style="margin-top: 10px">
            <div><div class="stat-label">MARCHA</div><div class="stat-val" style="color:#e10600">M<span id="gearTxt">1</span></div></div>
            <div style="text-align: right"><div class="stat-label">VELOCIDADE</div><div class="stat-val"><span id="speedTxt">0</span> KM/H</div></div>
        </div>
    </div>

    <div id="lights-container"><div class="light-row"><div id="L1" class="bulb"></div><div id="L2" class="bulb"></div><div id="L3" class="bulb"></div><div id="L4" class="bulb"></div><div id="L5" class="bulb"></div></div></div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const TEAMS = [{name:"FERRARI", color:0xe10600},{name:"MERCEDES", color:0x00d2be},{name:"RED BULL", color:0x0600ef},{name:"MCLAREN", color:0xff8700},{name:"ASTON", color:0x006f62},{name:"ALPINE", color:0x0093cc}];
        const GEAR_LIMITS = [0, 80, 120, 160, 200, 240, 280, 310, 360]; 

        let scene, camera, renderer, player, cachedModel;
        let cars = [], raceStatus = 'preparing', maxLaps = 3, finishOrder = [];
        const TRACK_RADIUS = 300, TRACK_WIDTH = 25;
        const keys = {};
        const CAR_Y = 0.78; 

        // Setup inicial das equipes
        const teamSel = document.getElementById('teamSelect');
        TEAMS.forEach((t, i) => teamSel.add(new Option(t.name, i)));

        async function startGame() {
            if(!document.getElementById('playerName').value) { alert("Insira seu nome!"); return; }
            maxLaps = parseInt(document.getElementById('lapLimit').value);
            document.getElementById('totalLapTxt').innerText = maxLaps;
            document.getElementById('ui-layer').style.display = 'none';

            initBase();
            await loadModel();
            buildTrack();

            const userTeam = document.getElementById('teamSelect').value;
            for(let i=0; i<20; i++) {
                const isUser = (i === 0);
                const car = createCar(isUser ? TEAMS[userTeam].color : TEAMS[i%6].color);
                
                const row = Math.floor(i / 2);
                const side = (i % 2 === 0) ? 6 : -6;
                const angle = -(row * 15) / TRACK_RADIUS;
                const r = TRACK_RADIUS + side;

                car.position.set(Math.cos(angle)*r, CAR_Y, Math.sin(angle)*r);
                car.lookAt(Math.cos(angle+0.1)*r, CAR_Y, Math.sin(angle+0.1)*r);
                
                car.userData = { 
                    speed: 0, angle: angle, isPlayer: isUser, lane: side, 
                    laps: 0, finished: false, lastAngle: angle, totalDist: 0,
                    name: isUser ? document.getElementById('playerName').value : "Bot " + i
                };
                
                scene.add(car);
                if(isUser) player = car; else cars.push(car);
            }

            document.getElementById('hud').style.display = 'block';
            startCountdown();
        }

        function initBase() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 3000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        }

        async function loadModel() {
            try { const gltf = await new GLTFLoader().loadAsync('f1model.glb'); cachedModel = gltf.scene; } catch(e){}
        }

        function buildTrack() {
            const track = new THREE.Mesh(new THREE.RingGeometry(TRACK_RADIUS-TRACK_WIDTH, TRACK_RADIUS+TRACK_WIDTH, 128), new THREE.MeshBasicMaterial({color:0x222222}));
            track.rotation.x = -Math.PI/2; track.position.y = 0.01; scene.add(track);
            const grass = new THREE.Mesh(new THREE.PlaneGeometry(5000,5000), new THREE.MeshBasicMaterial({color:0x3b7d32}));
            grass.rotation.x = -Math.PI/2; scene.add(grass);
        }

        function createCar(color) {
            const g = new THREE.Group();
            if(cachedModel) {
                const m = cachedModel.clone();
                m.traverse(c => { if(c.isMesh) {
                    c.material = c.material.clone();
                    if(c.name.toLowerCase().includes("body")) c.material.color.set(color);
                }});
                m.position.y = 0.5; g.add(m);
            } else { g.add(new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshBasicMaterial({color}))); }
            return g;
        }

        function startCountdown() {
            const container = document.getElementById('lights-container');
            container.style.display = 'block';
            let lit = 0;
            const t = setInterval(() => {
                lit++;
                if(lit <= 5) document.getElementById('L'+lit).classList.add('red');
                else {
                    clearInterval(t);
                    setTimeout(() => {
                        document.querySelectorAll('.bulb').forEach(b => b.classList.remove('red'));
                        raceStatus = 'racing';
                        setTimeout(() => container.style.display = 'none', 2000);
                    }, 1000);
                }
            }, 1000);
            animate();
        }

        function handleCollisions() {
    const all = [player, ...cars];
    for(let i=0; i<all.length; i++) {
        for(let j=i+1; j<all.length; j++) {
            const dist = all[i].position.distanceTo(all[j].position);
            
            if(dist < 3.0) { 
                // Se for o player, perde um pouco mais (0.85)
                // Se for IA, perde quase nada (0.97) para não travar a pista
                all[i].userData.speed *= all[i].userData.isPlayer ? 0.85 : 0.97;
                all[j].userData.speed *= all[j].userData.isPlayer ? 0.85 : 0.97;
                
                // Reduzimos o empurrão para a IA não bugar fora da pista
                if(all[i].userData.isPlayer) all[i].translateZ(-0.1);
            }
        }
    }
}

        function update() {
            if(raceStatus !== 'racing') return;
            const dt = 1/60;

            // --- PLAYER PHYSICS ---
            let speedKmh = player.userData.speed * 320;
            
            if(keys['w'] && !player.userData.finished) {
                // Aceleração potente
                let accelBase = (speedKmh < 200) ? 0.008 : 0.005;
                player.userData.speed += accelBase;
            }
            
            // ATRITO CALIBRADO PARA PASSAR DE 300 KM/H
            // Se passar de 340 o atrito aumenta muito (limite real)
            player.userData.speed *= (speedKmh > 340) ? 0.990 : 0.995;
            
            if(keys['s']) player.userData.speed -= 0.03;
            player.userData.speed = Math.max(0, player.userData.speed);

            // DIREÇÃO PROPORCIONAL
            let steerPower = Math.min(speedKmh / 150, 1.0) * 0.035;
            if(keys['a']) player.userData.angle += steerPower;
            if(keys['d']) player.userData.angle -= steerPower;

            player.rotation.y = player.userData.angle;
            player.translateZ(player.userData.speed * 2.5);
            player.position.y = CAR_Y;

           // --- IA Lógica de Movimento e Ultrapassagem ---
cars.forEach(ai => {
    if(ai.userData.finished) return;

    // 1. Aceleração da IA (Sincronizada com seu multiplicador de 2.5)
    if(ai.userData.speed < 1.05) ai.userData.speed += 0.004;
    
    // 2. Lógica de "Radar" para Ultrapassagem
    // A IA verifica se há alguém na frente dela na mesma faixa
    const detectionRange = 15; // Distância de detecção
    let carInFront = false;

    [player, ...cars].forEach(other => {
        if (other === ai) return;
        
        // Calcula a distância angular aproximada
        const dist = Math.abs(ai.userData.lastAngle - other.userData.lastAngle);
        // Se estiverem na mesma faixa e próximos
        if (dist < 0.05 && ai.userData.lane === other.userData.lane) {
            carInFront = true;
        }
    });

    // 3. Tomada de Decisão: Mudar de faixa?
    if (carInFront) {
        // Tenta mudar para uma faixa aleatória (Esquerda ou Direita)
        const targetLane = (Math.random() > 0.5) ? 6 : -6;
        // Move suavemente para a nova faixa
        ai.userData.lane = THREE.MathUtils.lerp(ai.userData.lane, targetLane, 0.05);
    }

    // 4. Movimento Angular (O multiplicador 2.5 que você aplicou)
    const speedMultiplier = 2.5; 
    const nextA = ai.userData.lastAngle + (ai.userData.speed / TRACK_RADIUS) * speedMultiplier;
    
    // Calcula a posição final baseada no raio + faixa atual
    const r = TRACK_RADIUS + ai.userData.lane;
    
    ai.position.set(Math.cos(nextA) * r, CAR_Y, Math.sin(nextA) * r);
    ai.lookAt(Math.cos(nextA + 0.1) * r, CAR_Y, Math.sin(nextA + 0.1) * r);
    
    ai.userData.lastAngle = nextA;
    checkLap(ai);
});

            handleCollisions();
            checkLap(player);
            
            // HUD UPDATE
            const kmhDisplay = Math.floor(player.userData.speed * 320);
            document.getElementById('speedTxt').innerText = kmhDisplay;
            
            // Cálculo da Marcha
            let gear = 1;
            for(let i=1; i<=8; i++) { if(kmhDisplay >= GEAR_LIMITS[i-1]) gear = i; }
            document.getElementById('gearTxt').innerText = gear;

            // Ranking
            const sorted = [player, ...cars].sort((a,b) => (b.userData.laps * 10 + b.userData.totalDist) - (a.userData.laps * 10 + a.userData.totalDist));
            document.getElementById('posTxt').innerText = sorted.findIndex(c => c.userData.isPlayer) + 1;
        }

        function checkLap(car) {
            const angle = Math.atan2(car.position.z, car.position.x);
            if(car.userData.lastAngle < 0 && angle >= 0) {
                car.userData.laps++;
                if(car.userData.isPlayer) document.getElementById('lapTxt').innerText = Math.min(car.userData.laps + 1, maxLaps);
                if(car.userData.laps >= maxLaps && !car.userData.finished) {
                    car.userData.finished = true;
                    finishOrder.push(car.userData.name);
                    if(car.userData.isPlayer) endRace();
                }
            }
            car.userData.lastAngle = angle;
            car.userData.totalDist = angle;
        }

        function endRace() {
            raceStatus = 'finished';
            const pod = document.getElementById('podium');
            pod.innerHTML = "<h3>RESULTADOS:</h3>";
            finishOrder.slice(0, 5).forEach((n, i) => pod.innerHTML += `<p>${i+1}º ${n}</p>`);
            document.getElementById('results-screen').style.display = 'flex';
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if(player) {
                const cp = new THREE.Vector3(0, 4, -12).applyMatrix4(player.matrixWorld);
                camera.position.lerp(cp, 0.1);
                camera.lookAt(player.position.x, 1.2, player.position.z);
            }
            renderer.render(scene, camera);
        }

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
        window.startGame = startGame;
    </script>
</body>
</html>
