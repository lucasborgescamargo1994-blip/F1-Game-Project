<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>F1 Grand Prix - Fixed Height</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .panel { width: 350px; background: rgba(15, 15, 15, 0.98); border: 2px solid #e10600; color: white; padding: 25px; pointer-events: all; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #hud { position: absolute; top: 20px; left: 20px; width: 220px; display: none; pointer-events: none; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: #aaa; }
        .stat-val { font-size: 18px; font-weight: bold; }
        #lights-container { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); background: #111; padding: 15px; border-radius: 10px; display: none; border: 4px solid #333; z-index: 100; }
        .light-row { display: flex; gap: 15px; }
        .bulb { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .bulb.red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        button { width: 100%; background: #e10600; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; border-radius: 4px; }
        select, input { width: 100%; padding: 12px; margin: 5px 0 10px 0; background: #222; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        #loading-screen { position: absolute; width: 100%; height: 100%; background: #000; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #results-screen { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: all; }
    </style>
</head>
<body>

    <div id="loading-screen"><h2>CARREGANDO MOTORES...</h2></div>
    <div id="results-screen">
        <h1>FIM DE PROVA</h1>
        <div id="podium" style="background: #222; padding: 20px; border-radius: 10px; width: 300px;"></div>
        <button onclick="location.reload()">NOVA CORRIDA</button>
    </div>

    <div id="ui-layer">
        <div class="panel">
            <h2 style="color: #e10600; text-align: center;">F1 SETUP</h2>
            <label>NOME:</label><input type="text" id="playerName" placeholder="Piloto">
            <label>PISTA:</label>
            <select id="trackSelect">
                <option value="oval">Indianapolis (Oval)</option>
                <option value="bahrain" selected>Bahrein GP (Real)</option>
            </select>
            <label>VOLTAS:</label>
            <select id="lapLimit"><option value="1">1 Volta</option><option value="3" selected>3 Voltas</option></select>
            <button onclick="startGame()">PILOTAR</button>
        </div>
    </div>

    <div id="hud" class="panel">
        <div class="stat-row"><div><div class="stat-label">POS</div><div class="stat-val" id="posTxt">1</div></div><div style="text-align: right"><div class="stat-label">VOLTA</div><div class="stat-val"><span id="lapTxt">1</span>/<span id="totalLapTxt">3</span></div></div></div>
        <div class="stat-row"><div class="stat-label">TEMPO</div><div class="stat-val" id="timerTxt">00:00.0</div></div>
        <div class="stat-row" style="margin-top: 10px"><div><div class="stat-label">MARCHA</div><div class="stat-val" style="color:#e10600">M<span id="gearTxt">1</span></div></div><div style="text-align: right"><div class="stat-label">VELOCIDADE</div><div class="stat-val"><span id="speedTxt">0</span> KM/H</div></div></div>
    </div>

    <div id="lights-container"><div class="light-row"><div id="L1" class="bulb"></div><div id="L2" class="bulb"></div><div id="L3" class="bulb"></div><div id="L4" class="bulb"></div><div id="L5" class="bulb"></div></div></div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, player, cachedModel, trackCurve, trackMesh;
        let cars = [], raceStatus = 'preparing', startTime = 0, maxLaps = 3, finishOrder = [];
        const keys = {};
        const GEAR_LIMITS = [0, 100, 140, 180, 220, 250, 280, 310, 345];

        async function startGame() {
            const trackType = document.getElementById('trackSelect').value;
            maxLaps = parseInt(document.getElementById('lapLimit').value);
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';

            initBase();
            await loadModel();
            buildTrack(trackType);

            for(let i=0; i<20; i++) {
                const isUser = (i === 0);
                const car = createCar(isUser ? 0xe10600 : 0x00d2be);
                
                const startP = 0.99 - (i * 0.006);
                const pos = trackCurve.getPointAt(startP);
                const tan = trackCurve.getTangentAt(startP);
                
                // AJUSTE DE ALTURA (Y = 0.5 para não enterrar)
                car.position.set(pos.x, 0.5, pos.z); 
                car.lookAt(pos.x + tan.x, 0.5, pos.z + tan.z);
                
                car.userData = { 
                    speedKmh: 0, isPlayer: isUser, laps: 0, 
                    lastP: startP, totalP: 0, finished: false,
                    onGrass: false,
                    name: isUser ? (document.getElementById('playerName').value || "Player") : "Bot " + i
                };
                
                scene.add(car);
                if(isUser) player = car; else cars.push(car);
            }

            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            startCountdown();
        }

        function initBase() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1));
        }

        async function loadModel() {
            const loader = new GLTFLoader();
            try { 
                const g = await loader.loadAsync('f1model.glb'); 
                cachedModel = g.scene; 
            } catch(e) {}
        }

        function buildTrack(type) {
            const pts = (type === 'oval') ? 
                new THREE.EllipseCurve(0, 0, 450, 300).getPoints(100).map(p => new THREE.Vector3(p.x, 0, p.y)) :
                [new THREE.Vector3(-450,0,300), new THREE.Vector3(450,0,300), new THREE.Vector3(550,0,100), new THREE.Vector3(400,0,-150), new THREE.Vector3(0,0,-200), new THREE.Vector3(-400,0,-100), new THREE.Vector3(-550,0,100), new THREE.Vector3(-450,0,300)];
            
            trackCurve = new THREE.CatmullRomCurve3(pts, true);
            const geo = new THREE.TubeGeometry(trackCurve, 200, 20, 8, true); // Pista mais larga
            trackMesh = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color: 0x222222}));
            trackMesh.scale.y = 0.01; 
            trackMesh.position.y = 0; 
            scene.add(trackMesh);

            const grass = new THREE.Mesh(new THREE.PlaneGeometry(5000,5000), new THREE.MeshLambertMaterial({color: 0x3b7d32}));
            grass.rotation.x = -Math.PI/2; 
            grass.position.y = -0.1; // Grama levemente abaixo
            scene.add(grass);
        }

        function createCar(color) {
            const g = new THREE.Group();
            if(cachedModel) {
                const m = cachedModel.clone();
                m.traverse(c => { if(c.isMesh) { c.material = c.material.clone(); if(c.name.includes("body")) c.material.color.set(color); }});
                g.add(m);
            } else { g.add(new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshLambertMaterial({color}))); }
            return g;
        }

        function update() {
            if(raceStatus !== 'racing') return;
            const dt = 1/60;

            // CHECAR SE ESTÁ NA GRAMA (Punição)
            // Calculamos a distância do carro até o ponto mais próximo da curva central da pista
            let closestPt = trackCurve.getPointAt(checkProgress(player, true));
            let distToCenter = new THREE.Vector2(player.position.x, player.position.z).distanceTo(new THREE.Vector2(closestPt.x, closestPt.z));
            player.userData.onGrass = distToCenter > 18; // Se afastar mais de 18 unidades, está na grama

            // FÍSICA PLAYER
            if(keys['w'] && !player.userData.finished) {
                let accelBase = (player.userData.speedKmh < 200 ? 65 : 35);
                if(player.userData.onGrass) accelBase = 10; // Punir aceleração na grama
                player.userData.speedKmh += accelBase * dt;
            } else { 
                player.userData.speedKmh *= 0.99; 
            }
            
            if(player.userData.onGrass) player.userData.speedKmh *= 0.97; // Punir velocidade máxima na grama
            if(keys['s']) player.userData.speedKmh -= 100 * dt;
            
            player.userData.speedKmh = Math.max(0, Math.min(340, player.userData.speedKmh));

            // DIREÇÃO
            const steerSpeed = player.userData.onGrass ? 1.5 : 2.5; 
            if(keys['a']) player.rotation.y += steerSpeed * dt;
            if(keys['d']) player.rotation.y -= steerSpeed * dt;

            // MOVIMENTO (Sempre mantém Y=0.5)
            player.translateZ(player.userData.speedKmh / 3.6 * dt);
            player.position.y = 0.5; 

            // IA
            cars.forEach(ai => {
                if(ai.userData.finished) return;
                const p = (ai.userData.lastP + 0.0006) % 1;
                const pos = trackCurve.getPointAt(p);
                ai.position.set(pos.x, 0.5, pos.z);
                ai.lookAt(trackCurve.getPointAt((p + 0.001)%1).x, 0.5, trackCurve.getPointAt((p + 0.001)%1).z);
                ai.userData.lastP = p;
                checkProgress(ai);
            });

            // HUD
            document.getElementById('speedTxt').innerText = Math.floor(player.userData.speedKmh);
            if(player.userData.onGrass) document.getElementById('speedTxt').style.color = "#ffaa00";
            else document.getElementById('speedTxt').style.color = "white";

            for(let i=1; i<=8; i++) { if(player.userData.speedKmh < GEAR_LIMITS[i]) { document.getElementById('gearTxt').innerText = i; break; } }
            updateRanking();
        }

        function checkProgress(car, onlyCheck = false) {
            const pos = car.position;
            let closestP = 0, minDist = Infinity;
            // Busca simplificada para performance
            for(let i=0; i<=100; i++) {
                const testP = i/100;
                const pPos = trackCurve.getPointAt(testP);
                const d = pos.distanceTo(pPos);
                if(d < minDist) { minDist = d; closestP = testP; }
            }
            
            if(onlyCheck) return closestP;

            if(car.userData.lastP > 0.8 && closestP < 0.2) {
                car.userData.laps++;
                if(car.userData.isPlayer) document.getElementById('lapTxt').innerText = Math.min(car.userData.laps + 1, maxLaps);
                if(car.userData.laps >= maxLaps && !car.userData.finished) {
                    car.userData.finished = true;
                    finishOrder.push(car.userData.name);
                    if(car.userData.isPlayer) endRace();
                }
            }
            car.userData.lastP = closestP;
            car.userData.totalP = car.userData.laps + closestP;
        }

        function updateRanking() {
            const sorted = [player, ...cars].sort((a,b) => b.userData.totalP - a.userData.totalP);
            document.getElementById('posTxt').innerText = sorted.findIndex(c => c.userData.isPlayer) + 1;
        }

        function startCountdown() {
            const c = document.getElementById('lights-container');
            c.style.display = 'block';
            let lit = 0;
            const t = setInterval(() => {
                lit++;
                if(lit <= 5) document.getElementById('L'+lit).classList.add('red');
                else {
                    clearInterval(t);
                    setTimeout(() => {
                        document.querySelectorAll('.bulb').forEach(b => b.classList.remove('red'));
                        raceStatus = 'racing'; startTime = Date.now();
                        setTimeout(() => c.style.display = 'none', 2000);
                    }, 1000);
                }
            }, 1000);
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if(player) {
                const cam = new THREE.Vector3(0, 4, -12).applyMatrix4(player.matrixWorld);
                camera.position.lerp(cam, 0.1);
                camera.lookAt(player.position.x, 1.5, player.position.z);
            }
            renderer.render(scene, camera);
        }

        function endRace() {
            raceStatus = 'finished';
            const p = document.getElementById('podium');
            p.innerHTML = "<b>TOP 5 RESULTADO:</b><br>";
            finishOrder.slice(0, 5).forEach((n, i) => p.innerHTML += `${i+1}º ${n}<br>`);
            document.getElementById('results-screen').style.display = 'flex';
        }

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
        window.startGame = startGame;
    </script>
</body>
</html>
