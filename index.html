<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>F1 Fix - Absolute Direction</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; justify-content: space-between; padding: 30px; box-sizing: border-box; }
        .panel { width: 300px; background: rgba(15, 15, 15, 0.95); border: 2px solid #e10600; color: white; padding: 20px; pointer-events: all; border-radius: 5px; }
        #lights-container { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); background: #111; padding: 15px; border-radius: 10px; display: none; border: 4px solid #333; z-index: 100; }
        .light-row { display: flex; gap: 15px; }
        .bulb { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .bulb.red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        button { width: 100%; background: #e10600; color: white; border: none; padding: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        select, input { width: 100%; padding: 10px; margin: 10px 0; background: #222; color: white; border: 1px solid #444; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="panel" id="menu-setup">
            <h2>F1 SIMULATOR</h2>
            <label>EQUIPE:</label>
            <select id="teamSelect"></select>
            <label>VOLTAS:</label>
            <input type="number" id="lapInput" value="3">
            <button onclick="startGame()">IR PARA RACE</button>
        </div>
        <div class="panel" id="hud" style="display: none;">
            <h2>STATUS</h2>
            <p>POS: <span id="posTxt">--</span>/20</p>
            <p>VEL: <span id="speedTxt">0</span> KMH</p>
        </div>
    </div>

    <div id="lights-container">
        <div class="light-row">
            <div class="bulb" id="L1"></div><div class="bulb" id="L2"></div>
            <div class="bulb" id="L3"></div><div class="bulb" id="L4"></div>
            <div class="bulb" id="L5"></div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        const TEAMS = [
            { name: "FERRARI", color: 0xe10600 }, { name: "MERCEDES", color: 0x00d2be },
            { name: "RED BULL", color: 0x0600ef }, { name: "MCLAREN", color: 0xff8700 }
        ];

        let scene, camera, renderer, player;
        let cars = [], isRacing = false, raceStatus = 'preparing';
        const TRACK_RADIUS = 300, TRACK_WIDTH = 25;

        const sel = document.getElementById('teamSelect');
        TEAMS.forEach((t, i) => sel.add(new Option(t.name, i)));

        function createNoiseTexture(colorBase) {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = colorBase;
            ctx.fillRect(0,0,256,256);
            for(let i=0; i<5000; i++){
                ctx.fillStyle = `rgba(0,0,0,0.1)`;
                ctx.fillRect(Math.random()*256, Math.random()*256, 1, 1);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(50, 50);
            return tex;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 200, 50);
            scene.add(sun);

            const grass = new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000), new THREE.MeshStandardMaterial({ map: createNoiseTexture('#3b7d32') }));
            grass.rotation.x = -Math.PI/2;
            scene.add(grass);

            const trackGeo = new THREE.RingGeometry(TRACK_RADIUS - TRACK_WIDTH, TRACK_RADIUS + TRACK_WIDTH, 128);
            const trackMat = new THREE.MeshStandardMaterial({ map: createNoiseTexture('#222') });
            const track = new THREE.Mesh(trackGeo, trackMat);
            track.rotation.x = -Math.PI/2;
            track.position.y = 0.05;
            scene.add(track);
        }

        function createCar(color, isPlayer) {
            const group = new THREE.Group();
            
            // ATENÇÃO: Geometria orientada para o Z (Frente do carro é no eixo Z)
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 4.5), new THREE.MeshStandardMaterial({color}));
            body.position.y = 0.4;
            group.add(body);
            
            const wing = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.6, 0.2), new THREE.MeshStandardMaterial({color: 0x111111}));
            wing.position.set(0, 0.8, -2.1); // Atrás do centro
            group.add(wing);

            const nose = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.2, 1), new THREE.MeshStandardMaterial({color}));
            nose.position.set(0, 0.3, 2.5); // À frente do centro
            group.add(nose);

            group.userData = { speed: 0, angle: 0, isPlayer, lane: (Math.random()-0.5)*15 };
            scene.add(group);
            return group;
        }

        window.startGame = function() {
            document.getElementById('menu-setup').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            init();

            for(let i=0; i<20; i++) {
                const team = TEAMS[i % TEAMS.length];
                const isUser = (i === 0);
                const car = createCar(team.color, isUser);
                
                const row = Math.floor(i / 2);
                const side = (i % 2 === 0) ? 6 : -6;
                
                // Posição no círculo
                const gridAngle = -(row * 15) / TRACK_RADIUS; 
                const radius = TRACK_RADIUS + side;
                car.position.set(Math.cos(gridAngle) * radius, 0, Math.sin(gridAngle) * radius);
                
                // ALINHAMENTO FORÇADO:
                // Miramos um ponto 1 metro à frente na curva.
                const lookAngle = gridAngle + 0.01; 
                const targetX = Math.cos(lookAngle) * radius;
                const targetZ = Math.sin(lookAngle) * radius;
                car.lookAt(targetX, 0, targetZ);
                
                // SINCRONIA TOTAL: 
                // userData.angle agora recebe a rotação Y real gerada pelo LookAt
                car.userData.angle = car.rotation.y;

                if(isUser) player = car;
                else cars.push(car);
            }
            startCountdown();
        }

        function startCountdown() {
            const container = document.getElementById('lights-container');
            container.style.display = 'block';
            let lit = 0;
            const timer = setInterval(() => {
                lit++;
                if(lit <= 5) document.getElementById(`L${lit}`).classList.add('red');
                else {
                    clearInterval(timer);
                    setTimeout(() => {
                        for(let i=1; i<=5; i++) document.getElementById(`L${i}`).classList.remove('red');
                        raceStatus = 'racing';
                        setTimeout(() => container.style.display = 'none', 2000);
                    }, 1500);
                }
            }, 1000);
            animate();
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function update() {
            // Travamos a rotação do player enquanto o semáforo estiver aceso
            if(raceStatus !== 'racing') {
                if(player) player.rotation.y = player.userData.angle;
                return;
            }

            // Player Physics
            if(keys['w']) player.userData.speed += 0.03;
            if(keys['s']) player.userData.speed -= 0.05;
            player.userData.speed *= 0.98;
            
            if(Math.abs(player.userData.speed) > 0.01) {
                const turn = (keys['a'] ? 1 : 0) - (keys['d'] ? 1 : 0);
                player.userData.angle += turn * 0.04 * (player.userData.speed/1.5);
            }
            
            player.rotation.y = player.userData.angle;
            // Usando translateZ garantimos que o movimento segue a orientação visual
            player.translateZ(player.userData.speed);

            // IA Physics
            cars.forEach((ai, i) => {
                const curA = Math.atan2(ai.position.z, ai.position.x);
                const nextA = curA + 0.04; 
                ai.lookAt(Math.cos(nextA)*(TRACK_RADIUS+ai.userData.lane), 0.4, Math.sin(nextA)*(TRACK_RADIUS+ai.userData.lane));
                ai.translateZ(1.1);
            });

            document.getElementById('speedTxt').innerText = Math.floor(player.userData.speed * 310);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if(player) {
                const camPos = new THREE.Vector3(0, 4, -14).applyMatrix4(player.matrixWorld);
                camera.position.lerp(camPos, 0.1);
                camera.lookAt(player.position.x, 1.5, player.position.z);
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>