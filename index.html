<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>F1 Simulator - Pro Performance</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }
        .panel { 
            width: 350px; background: rgba(15, 15, 15, 0.98); border: 2px solid #e10600; 
            color: white; padding: 25px; pointer-events: all; border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #hud { position: absolute; top: 20px; left: 20px; width: 200px; display: none; pointer-events: none; }
        
        #lights-container { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); background: #111; padding: 15px; border-radius: 10px; display: none; border: 4px solid #333; z-index: 100; }
        .light-row { display: flex; gap: 15px; }
        .bulb { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .bulb.red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        
        button { width: 100%; background: #e10600; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; }
        button:hover { background: #ff1e16; }
        
        label { display: block; margin-top: 12px; font-size: 12px; color: #aaa; }
        select, input { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #222; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        
        #loading-screen { 
            position: absolute; width: 100%; height: 100%; background: #000; color: white; 
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        
        canvas { image-rendering: pixelated; } /* Estilo para resoluções baixas não borrarem */
    </style>
</head>
<body>

    <div id="loading-screen">
        <h2 id="loading-msg">CARREGANDO MODELO 3D...</h2>
        <p>Isso pode levar alguns segundos dependendo da sua conexão.</p>
    </div>

    <div id="ui-layer">
        <div class="panel" id="menu-setup">
            <h2 style="color: #e10600; margin-top: 0;">F1 SIMULATOR</h2>
            
            <label>QUALIDADE GRÁFICA:</label>
            <select id="qualitySelect">
                <option value="low">BAIXA (640x480 - Muito Leve)</option>
                <option value="mid" selected>MÉDIA (800x600 - Recomendado)</option>
                <option value="high">ALTA (Nativa - Requer GPU)</option>
            </select>

            <label>EQUIPE:</label>
            <select id="teamSelect"></select>
            
            <label>NÚMERO DE IAs (Reduza se travar):</label>
            <input type="number" id="aiCount" value="19" min="1" max="19">

            <button onclick="startGame()">INICIAR GRANDE PRÊMIO</button>
        </div>
    </div>

    <div id="hud" class="panel">
        <p>POSIÇÃO: <span id="posTxt">--</span>/20</p>
        <p>VELOCIDADE: <span id="speedTxt">0</span> KM/H</p>
    </div>

    <div id="lights-container">
        <div class="light-row">
            <div id="L1" class="bulb"></div><div id="L2" class="bulb"></div>
            <div id="L3" class="bulb"></div><div id="L4" class="bulb"></div>
            <div id="L5" class="bulb"></div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const TEAMS = [
            { name: "FERRARI", color: 0xe10600 }, { name: "MERCEDES", color: 0x00d2be },
            { name: "RED BULL", color: 0x0600ef }, { name: "MCLAREN", color: 0xff8700 },
            { name: "ASTON MARTIN", color: 0x006f62 }, { name: "ALPINE", color: 0x0093cc }
        ];

        let scene, camera, renderer, player, cachedModel;
        let cars = [], raceStatus = 'preparing';
        const TRACK_RADIUS = 300, TRACK_WIDTH = 25;
        const keys = {};

        // Link do seu modelo
        const MODEL_URL = 'f1model.glb'; 

        // Popular equipes
        const sel = document.getElementById('teamSelect');
        TEAMS.forEach((t, i) => sel.add(new Option(t.name, i)));

        function initRenderer() {
            const quality = document.getElementById('qualitySelect').value;
            renderer = new THREE.WebGLRenderer({ antialias: (quality === 'high') });
            
            if (quality === 'low') {
                renderer.setSize(640, 480, false);
                renderer.setPixelRatio(1);
            } else if (quality === 'mid') {
                renderer.setSize(800, 600, false);
                renderer.setPixelRatio(1);
            } else {
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
            }

            renderer.shadowMap.enabled = (quality === 'high');
            document.body.appendChild(renderer.domElement);
        }

        async function loadAssets() {
            const loader = new GLTFLoader();
            try {
                const gltf = await loader.loadAsync(MODEL_URL);
                cachedModel = gltf.scene;
                // Otimização de materiais para performance
                cachedModel.traverse(child => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshLambertMaterial({ 
                            color: child.material.color,
                            map: child.material.map 
                        });
                    }
                });
            } catch (e) {
                console.error("Erro ao carregar modelo 3D:", e);
                // O jogo continuará com blocos se o modelo falhar
            }
        }

        function buildTrack() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            
            const quality = document.getElementById('qualitySelect').value;
            const aspect = quality === 'high' ? window.innerWidth / window.innerHeight : 640/480;
            camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 3000);

            // Luzes simples
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 200, 50);
            scene.add(sun);

            // Chão e Pista (Texturas simples)
            const grassGeo = new THREE.PlaneGeometry(5000, 5000);
            const grassMat = new THREE.MeshBasicMaterial({ color: 0x3b7d32 });
            const grass = new THREE.Mesh(grassGeo, grassMat);
            grass.rotation.x = -Math.PI/2;
            scene.add(grass);

            const trackGeo = new THREE.RingGeometry(TRACK_RADIUS - TRACK_WIDTH, TRACK_RADIUS + TRACK_WIDTH, 64);
            const trackMat = new THREE.MeshBasicMaterial({ color: 0x222222 });
            const track = new THREE.Mesh(trackGeo, trackMat);
            track.rotation.x = -Math.PI/2;
            track.position.y = 0.05;
            scene.add(track);
        }

        function createCar(color, isPlayer) {
            const group = new THREE.Group();
            
            if (cachedModel) {
                const model = cachedModel.clone();
                model.traverse(child => {
                    if (child.isMesh && child.name.toLowerCase().includes("body")) {
                        child.material = child.material.clone();
                        child.material.color.set(color);
                    }
                });
                group.add(model);
            } else {
                const box = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.6, 4), new THREE.MeshLambertMaterial({color}));
                box.position.y = 0.3;
                group.add(box);
            }

            group.userData = { speed: 0, angle: 0, isPlayer, lane: (Math.random()-0.5)*12 };
            scene.add(group);
            return group;
        }

        window.startGame = async function() {
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('menu-setup').style.display = 'none';

            initRenderer();
            await loadAssets();
            buildTrack();

            const totalAI = parseInt(document.getElementById('aiCount').value);
            const userTeamIndex = document.getElementById('teamSelect').value;

            for(let i=0; i <= totalAI; i++) {
                const isUser = (i === 0);
                const team = isUser ? TEAMS[userTeamIndex] : TEAMS[i % TEAMS.length];
                const car = createCar(team.color, isUser);
                
                const row = Math.floor(i / 2);
                const side = (i % 2 === 0) ? 5 : -5;
                const gridAngle = -(row * 12) / TRACK_RADIUS; 
                const radius = TRACK_RADIUS + side;
                
                car.position.set(Math.cos(gridAngle) * radius, 0, Math.sin(gridAngle) * radius);
                const lookAngle = gridAngle + 0.01; 
                car.lookAt(Math.cos(lookAngle) * radius, 0, Math.sin(lookAngle) * radius);
                car.userData.angle = car.rotation.y;

                if(isUser) player = car;
                else cars.push(car);
            }

            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            startCountdown();
        }

        function startCountdown() {
            const container = document.getElementById('lights-container');
            container.style.display = 'block';
            let lit = 0;
            const timer = setInterval(() => {
                lit++;
                if(lit <= 5) document.getElementById(`L${lit}`).classList.add('red');
                else {
                    clearInterval(timer);
                    setTimeout(() => {
                        for(let i=1; i<=5; i++) document.getElementById(`L${i}`).classList.remove('red');
                        raceStatus = 'racing';
                        setTimeout(() => container.style.display = 'none', 2000);
                    }, 1500);
                }
            }, 1000);
            animate();
        }

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function update() {
            if(raceStatus !== 'racing') {
                if(player) player.rotation.y = player.userData.angle;
                return;
            }

            // Jogador
            if(keys['w']) player.userData.speed += 0.035;
            if(keys['s']) player.userData.speed -= 0.06;
            player.userData.speed *= 0.985;
            
            if(Math.abs(player.userData.speed) > 0.01) {
                const turn = (keys['a'] ? 1 : 0) - (keys['d'] ? 1 : 0);
                player.userData.angle += turn * 0.04 * (player.userData.speed/1.8);
            }
            player.rotation.y = player.userData.angle;
            player.translateZ(player.userData.speed);

            // IA
            cars.forEach(ai => {
                const curA = Math.atan2(ai.position.z, ai.position.x);
                const nextA = curA + 0.04; 
                const r = TRACK_RADIUS + ai.userData.lane;
                ai.lookAt(Math.cos(nextA)*r, 0, Math.sin(nextA)*r);
                ai.translateZ(1.15);
            });

            document.getElementById('speedTxt').innerText = Math.floor(player.userData.speed * 315);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if(player) {
                const camPos = new THREE.Vector3(0, 3.5, -12).applyMatrix4(player.matrixWorld);
                camera.position.lerp(camPos, 0.1);
                camera.lookAt(player.position.x, 1.2, player.position.z);
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if(renderer && document.getElementById('qualitySelect').value === 'high') {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
