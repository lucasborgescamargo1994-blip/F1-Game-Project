<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>F1 Pro - Real Steering</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .panel { width: 350px; background: rgba(15, 15, 15, 0.98); border: 2px solid #e10600; color: white; padding: 25px; pointer-events: all; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #hud { position: absolute; top: 20px; left: 20px; width: 220px; display: none; pointer-events: none; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: #aaa; }
        .stat-val { font-size: 18px; font-weight: bold; }
        #lights-container { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); background: #111; padding: 15px; border-radius: 10px; display: none; border: 4px solid #333; z-index: 100; }
        .light-row { display: flex; gap: 15px; }
        .bulb { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .bulb.red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        button { width: 100%; background: #e10600; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; border-radius: 4px; }
        select, input { width: 100%; padding: 12px; margin: 5px 0 10px 0; background: #222; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        #loading-screen { position: absolute; width: 100%; height: 100%; background: #000; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #results-screen { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: all; }
    </style>
</head>
<body>

    <div id="loading-screen"><h2>CALIBRANDO DIREÇÃO...</h2></div>
    <div id="results-screen">
        <h1>FIM DE PROVA</h1>
        <div id="podium" style="background: #222; padding: 20px; border-radius: 10px; width: 300px;"></div>
        <button onclick="location.reload()">NOVA CORRIDA</button>
    </div>

    <div id="ui-layer">
        <div class="panel">
            <h2 style="color: #e10600; text-align: center;">F1 GP SETUP</h2>
            <label>PILOTO:</label><input type="text" id="playerName" placeholder="Nome">
            <label>PISTA:</label>
            <select id="trackSelect">
                <option value="oval">Indianapolis (Oval)</option>
                <option value="bahrain" selected>Bahrein GP (Real)</option>
            </select>
            <button onclick="startGame()">INICIAR</button>
        </div>
    </div>

    <div id="hud" class="panel">
        <div class="stat-row"><div><div class="stat-label">POS</div><div class="stat-val" id="posTxt">1</div></div><div style="text-align: right"><div class="stat-label">VOLTA</div><div class="stat-val" id="lapTxt">1/3</div></div></div>
        <div class="stat-row" style="margin-top: 10px"><div><div class="stat-label">MARCHA</div><div class="stat-val" style="color:#e10600">M<span id="gearTxt">1</span></div></div><div style="text-align: right"><div class="stat-label">VELOCIDADE</div><div class="stat-val"><span id="speedTxt">0</span> KM/H</div></div></div>
    </div>

    <div id="lights-container"><div class="light-row"><div id="L1" class="bulb"></div><div id="L2" class="bulb"></div><div id="L3" class="bulb"></div><div id="L4" class="bulb"></div><div id="L5" class="bulb"></div></div></div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>

    <script	type="module">
        
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    
    // ADICIONE ESTA LINHA AQUI:
    import { TRACK_DATA } from './tracks.js';
		import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, player, cachedModel, trackCurve;
        let cars = [], raceStatus = 'preparing', startTime = 0, finishOrder = [];
        const keys = {};
        const CAR_Y = 0.75; // AJUSTE FINO DA ALTURA AQUI

        async function startGame() {
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';

            initBase();
            await loadModel();
            buildTrack(document.getElementById('trackSelect').value);

            for(let i=0; i<20; i++) {
                const isUser = (i === 0);
                const car = createCar(isUser ? 0xe10600 : 0x333333);
                const startP = 0.99 - (i * 0.007);
                const pos = trackCurve.getPointAt(startP);
                const tan = trackCurve.getTangentAt(startP);
                
                car.position.set(pos.x, CAR_Y, pos.z); 
                car.lookAt(pos.x + tan.x, CAR_Y, pos.z + tan.z);
                car.userData = { speedKmh: 0, isPlayer: isUser, lastP: startP, totalP: 0, laps: 0, finished: false, name: isUser ? "Você" : "Bot "+i };
                
                scene.add(car);
                if(isUser) player = car; else cars.push(car);
            }

            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            startCountdown();
        }

        function initBase() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        }

        async function loadModel() {
            try { const g = await new GLTFLoader().loadAsync('f1model.glb'); cachedModel = g.scene; } catch(e) {}
        }

        function buildTrack(type) {
            const pts = (type === 'oval') ? 
                new THREE.EllipseCurve(0, 0, 450, 300).getPoints(100).map(p => new THREE.Vector3(p.x, 0, p.y)) :
                [new THREE.Vector3(-450,0,300), new THREE.Vector3(450,0,300), new THREE.Vector3(550,0,100), new THREE.Vector3(400,0,-150), new THREE.Vector3(0,0,-200), new THREE.Vector3(-400,0,-100), new THREE.Vector3(-550,0,100), new THREE.Vector3(-450,0,300)];
            trackCurve = new THREE.CatmullRomCurve3(pts, true);
            const geo = new THREE.TubeGeometry(trackCurve, 200, 22, 8, true);
            const mesh = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color: 0x222222}));
            mesh.scale.y = 0.01; scene.add(mesh);
            const grass = new THREE.Mesh(new THREE.PlaneGeometry(5000,5000), new THREE.MeshLambertMaterial({color: 0x3b7d32}));
            grass.rotation.x = -Math.PI/2; grass.position.y = -0.05; scene.add(grass);
        }

        function createCar(color) {
            const g = new THREE.Group();
            if(cachedModel) {
                const m = cachedModel.clone();
                m.traverse(c => { if(c.isMesh) { c.material = c.material.clone(); if(c.name.includes("body")) c.material.color.set(color); }});
                g.add(m);
            } else { g.add(new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshLambertMaterial({color}))); }
            return g;
        }

        function update() {
            if(raceStatus !== 'racing') return;
            const dt = 1/60;

            // FÍSICA E ACELERAÇÃO
            if(keys['w']) player.userData.speedKmh += (player.userData.speedKmh < 150 ? 70 : 35) * dt;
            else player.userData.speedKmh *= 0.99;
            if(keys['s']) player.userData.speedKmh -= 120 * dt;
            player.userData.speedKmh = Math.max(0, Math.min(340, player.userData.speedKmh));

            // --- DIREÇÃO REALISTA (Proporcional à Velocidade) ---
            let speedFactor = player.userData.speedKmh / 180; // No auge em 180km/h
            speedFactor = Math.min(speedFactor, 1.1); // Limita o giro máximo
            
            const steerAbility = 2.8 * speedFactor; // Multiplica a força do giro pela velocidade

            if(keys['a']) player.rotation.y += steerAbility * dt;
            if(keys['d']) player.rotation.y -= steerAbility * dt;

            player.translateZ(player.userData.speedKmh / 3.6 * dt);
            player.position.y = CAR_Y; 

            // HUD E LOGICA
            document.getElementById('speedTxt').innerText = Math.floor(player.userData.speedKmh);
            document.getElementById('gearTxt').innerText = Math.ceil(player.userData.speedKmh / 45) || 1;
            
            checkProgress(player);
            cars.forEach(ai => {
                const p = (ai.userData.lastP + 0.0006) % 1;
                ai.position.set(trackCurve.getPointAt(p).x, CAR_Y, trackCurve.getPointAt(p).z);
                ai.lookAt(trackCurve.getPointAt((p+0.001)%1).x, CAR_Y, trackCurve.getPointAt((p+0.001)%1).z);
                ai.userData.lastP = p;
                checkProgress(ai);
            });
            updateRanking();
        }

        function checkProgress(car) {
            let closestP = 0, minDist = Infinity;
            for(let i=0; i<=100; i+=2) {
                const d = car.position.distanceTo(trackCurve.getPointAt(i/100));
                if(d < minDist) { minDist = d; closestP = i/100; }
            }
            if(car.userData.lastP > 0.8 && closestP < 0.2) car.userData.laps++;
            car.userData.lastP = closestP;
            car.userData.totalP = car.userData.laps + closestP;
            if(car.userData.isPlayer) document.getElementById('lapTxt').innerText = (car.userData.laps+1)+"/3";
        }

        function updateRanking() {
            const sorted = [player, ...cars].sort((a,b) => b.userData.totalP - a.userData.totalP);
            document.getElementById('posTxt').innerText = sorted.findIndex(c => c.userData.isPlayer) + 1;
        }

        function startCountdown() {
            const c = document.getElementById('lights-container');
            c.style.display = 'block';
            let lit = 0;
            const t = setInterval(() => {
                lit++;
                if(lit <= 5) document.getElementById('L'+lit).classList.add('red');
                else {
                    clearInterval(t);
                    setTimeout(() => {
                        document.querySelectorAll('.bulb').forEach(b => b.classList.remove('red'));
                        raceStatus = 'racing';
                        setTimeout(() => c.style.display = 'none', 2000);
                    }, 1000);
                }
            }, 1000);
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if(player) {
                const cam = new THREE.Vector3(0, 4, -12).applyMatrix4(player.matrixWorld);
                camera.position.lerp(cam, 0.1);
                camera.lookAt(player.position.x, 1.5, player.position.z);
            }
            renderer.render(scene, camera);
        }

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
        window.startGame = startGame;
    </script>
</body>
</html>
