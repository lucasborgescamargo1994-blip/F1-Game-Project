<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>F1 Grand Prix Simulator</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .panel { 
            width: 350px; background: rgba(15, 15, 15, 0.98); border: 2px solid #e10600; 
            color: white; padding: 25px; pointer-events: all; border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #hud { position: absolute; top: 20px; left: 20px; width: 220px; display: none; pointer-events: none; }
        #lights-container { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); background: #111; padding: 15px; border-radius: 10px; display: none; border: 4px solid #333; z-index: 100; }
        .light-row { display: flex; gap: 15px; }
        .bulb { width: 40px; height: 40px; background: #222; border-radius: 50%; }
        .bulb.red { background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        button { width: 100%; background: #e10600; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; border-radius: 4px; }
        label { display: block; margin-top: 12px; font-size: 12px; color: #aaa; }
        select, input { width: 100%; padding: 12px; margin: 5px 0 10px 0; background: #222; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
        #loading-screen { position: absolute; width: 100%; height: 100%; background: #000; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #results-screen { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: all; }
        canvas { image-rendering: pixelated; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <h2>PREPARANDO O GRID...</h2>
        <p>Aqueça os pneus!</p>
    </div>

    <div id="results-screen">
        <h1 style="color: #e10600">CORRIDA ENCERRADA</h1>
        <div id="podium" style="background: #222; padding: 20px; border-radius: 10px; width: 300px; text-align: center;"></div>
        <button onclick="location.reload()">NOVA CORRIDA</button>
    </div>

    <div id="ui-layer">
        <div class="panel" id="menu-setup">
            <h2 style="color: #e10600; margin-top: 0; text-align: center;">F1 GP SETUP</h2>
            
            <label>SEU NOME:</label>
            <input type="text" id="playerName" placeholder="Ex: Senna">

            <label>QUALIDADE GRÁFICA:</label>
            <select id="qualitySelect">
                <option value="low">BAIXA (Performance)</option>
                <option value="mid" selected>MÉDIA (Recomendado)</option>
                <option value="high">ALTA (Nativa)</option>
            </select>

            <label>EQUIPE:</label>
            <select id="teamSelect"></select>
            
            <label>DISTÂNCIA (VOLTAS):</label>
            <select id="lapLimit">
                <option value="1">1 Volta (Sprint)</option>
                <option value="3" selected>3 Voltas</option>
                <option value="5">5 Voltas</option>
                <option value="10">10 Voltas</option>
            </select>

            <button onclick="startGame()">IR PARA A PISTA</button>
        </div>
    </div>

    <div id="hud" class="panel">
        <p>VOLTA: <span id="lapTxt">1</span> / <span id="totalLapTxt">3</span></p>
        <p>TEMPO: <span id="timerTxt">00:00.0</span></p>
        <p>MARCHA: <span id="gearTxt" style="color:#e10600">1</span></p>
        <p>VELO: <span id="speedTxt">0</span> KM/H</p>
    </div>

    <div id="lights-container">
        <div class="light-row">
            <div id="L1" class="bulb"></div><div id="L2" class="bulb"></div>
            <div id="L3" class="bulb"></div><div id="L4" class="bulb"></div>
            <div id="L5" class="bulb"></div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const TEAMS = [
            { name: "FERRARI", color: 0xe10600 }, { name: "MERCEDES", color: 0x00d2be },
            { name: "RED BULL", color: 0x0600ef }, { name: "MCLAREN", color: 0xff8700 },
            { name: "ASTON MARTIN", color: 0x006f62 }, { name: "ALPINE", color: 0x0093cc }
        ];

        const AI_NAMES = ["Verstappen", "Hamilton", "Leclerc", "Norris", "Alonso", "Sainz", "Perez", "Russell", "Piastri", "Gasly", "Stroll", "Hulkenberg", "Albon", "Ricciardo", "Bottas", "Magnussen", "Tsunoda", "Zhou", "Sargeant"];

        let scene, camera, renderer, player, cachedModel;
        let cars = [], raceStatus = 'preparing';
        let startTime = 0, currentLaps = 1, maxLaps = 3, finishOrder = [];
        const TRACK_RADIUS = 300, TRACK_WIDTH = 25;
        const keys = {};

        // Variáveis de Física (Suas calibragens)
        let currentGear = 1;
        const GEAR_LIMITS = [0, 80, 120, 160, 180, 230, 250, 270, 300]; 
        const ACCEL_POWER = 0.55; 
        const MODEL_URL = 'f1model.glb'; 

        const teamSel = document.getElementById('teamSelect');
        TEAMS.forEach((t, i) => teamSel.add(new Option(t.name, i)));

        async function startGame() {
            const nameInput = document.getElementById('playerName').value;
            if(!nameInput) { alert("Por favor, insira seu nome!"); return; }
            
            maxLaps = parseInt(document.getElementById('lapLimit').value);
            document.getElementById('totalLapTxt').innerText = maxLaps;
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';

            initRenderer();
            await loadAssets();
            buildWorld();

            const userTeamIdx = document.getElementById('teamSelect').value;
            
            // Criar Grid
            for(let i=0; i < 20; i++) {
                const isUser = (i === 0);
                const team = isUser ? TEAMS[userTeamIdx] : TEAMS[i % TEAMS.length];
                const car = createCar(team.color, isUser);
                
                const row = Math.floor(i / 2);
                const side = (i % 2 === 0) ? 5 : -5;
                const gridAngle = -(row * 12) / TRACK_RADIUS; 
                const radius = TRACK_RADIUS + side;
                
                car.position.set(Math.cos(gridAngle) * radius, 0, Math.sin(gridAngle) * radius);
                const lookAngle = gridAngle + 0.01; 
                car.lookAt(Math.cos(lookAngle) * radius, 0, Math.sin(lookAngle) * radius);
                
                car.userData = { 
                    speed: 0, 
                    angle: car.rotation.y, 
                    isPlayer: isUser, 
                    lane: side, 
                    name: isUser ? nameInput : AI_NAMES[i-1],
                    laps: 0,
                    finished: false,
                    lastAngle: gridAngle
                };
                
                scene.add(car);
                if(isUser) player = car;
                else cars.push(car);
            }

            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            startCountdown();
        }

        function initRenderer() {
            const quality = document.getElementById('qualitySelect').value;
            renderer = new THREE.WebGLRenderer({ antialias: (quality === 'high') });
            if (quality === 'low') renderer.setSize(640, 480, false);
            else if (quality === 'mid') renderer.setSize(800, 600, false);
            else renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(1);
            document.body.appendChild(renderer.domElement);
        }

       async function loadAssets() {
    const loader = new GLTFLoader();
    try {
        const gltf = await loader.loadAsync(MODEL_URL);
        cachedModel = gltf.scene;

        // O segredo está em não criar um material NOVO do zero, 
        // mas sim ajustar o que já existe no modelo.
        cachedModel.traverse(child => {
            if (child.isMesh) {
                // Mantemos a textura original se ela existir
                child.castShadow = true;
                child.receiveShadow = true;
            }
        });
    } catch (e) {
        console.error("Erro ao carregar modelo:", e);
    }
}

        function buildWorld() {
    scene = new THREE.Scene();
    // Cor do Céu (Azul claro)
    scene.background = new THREE.Color(0x87ceeb); 
    
    camera = new THREE.PerspectiveCamera(60, renderer.domElement.width/renderer.domElement.height, 0.1, 3000);
    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    
    // --- GRAMA (Fica na base, y = 0) ---
    const grassGeo = new THREE.PlaneGeometry(5000, 5000);
    const grassMat = new THREE.MeshBasicMaterial({ color: 0x3b7d32 }); 
    const grass = new THREE.Mesh(grassGeo, grassMat);
    grass.rotation.x = -Math.PI/2;
    grass.position.y = 0; // Base
    scene.add(grass);

    // --- PISTA (Elevada apenas 0.01 para parar de piscar) ---
    const trackGeo = new THREE.RingGeometry(TRACK_RADIUS - TRACK_WIDTH, TRACK_RADIUS + TRACK_WIDTH, 128);
    const trackMat = new THREE.MeshBasicMaterial({ color: 0x222222 });
    const track = new THREE.Mesh(trackGeo, trackMat);
    track.rotation.x = -Math.PI/2;
    track.position.y = 0.01; // Diferença mínima necessária
    scene.add(track);

    // --- LINHA DE CHEGADA (Elevada 0.02 para ficar sobre a pista) ---
    const lineGeo = new THREE.PlaneGeometry(TRACK_WIDTH * 2, 2);
    const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
    const line = new THREE.Mesh(lineGeo, lineMat);
    line.rotation.x = -Math.PI/2;
    line.position.set(TRACK_RADIUS, 0.02, 0); 
    scene.add(line);
}

        function createCar(color, isPlayer) {
    const group = new THREE.Group();
    
    if (cachedModel) {
        const model = cachedModel.clone();
        
        // Ajuste de altura que definimos antes
        model.position.y = 0.5; 

        model.traverse(child => {
            if (child.isMesh) {
                // Clonamos o material para que a cor de uma equipe não pinte todas as outras
                child.material = child.material.clone();

                // Aplicamos a cor apenas nas partes que contém "body" ou "chassis" no nome
                // Se o seu modelo não tiver esses nomes, ele manterá a textura original
                if (child.name.toLowerCase().includes("body") || child.name.toLowerCase().includes("paint")) {
                    child.material.color.set(color);
                }
            }
        });
        group.add(model);
    } else {
        // Fallback caso o modelo suma
        const box = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.6, 4), new THREE.MeshLambertMaterial({color}));
        box.position.y = 0.3;
        group.add(box);
    }

    return group;
}

        function startCountdown() {
            const container = document.getElementById('lights-container');
            container.style.display = 'block';
            let lit = 0;
            const timer = setInterval(() => {
                lit++;
                if(lit <= 5) document.getElementById(`L${lit}`).classList.add('red');
                else {
                    clearInterval(timer);
                    setTimeout(() => {
                        document.querySelectorAll('.bulb').forEach(b => b.classList.remove('red'));
                        raceStatus = 'racing';
                        startTime = Date.now();
                        setTimeout(() => container.style.display = 'none', 2000);
                    }, 1500);
                }
            }, 1000);
            animate();
        }

        function update() {
            if(raceStatus === 'preparing') {
                if(player) player.rotation.y = player.userData.angle;
                return;
            }

            // Tempo
            if(raceStatus === 'racing') {
                const diff = new Date(Date.now() - startTime);
                document.getElementById('timerTxt').innerText = diff.toISOString().substr(14, 7);
            }

            // Player Physics (Suas variáveis)
            let speedKmh = player.userData.speed * 320;
            if(keys['w'] && !player.userData.finished) {
                for(let i=1; i<=8; i++) { if(speedKmh < GEAR_LIMITS[i]) { currentGear = i; break; } }
                let accelMult = (speedKmh > 305) ? 0.15 : 1.0;
                player.userData.speed += (ACCEL_POWER * accelMult) * 0.01;
            }
            player.userData.speed *= (speedKmh > 320) ? 0.991 : 0.994;
            if(keys['s']) player.userData.speed -= 0.04;
            player.userData.speed = Math.max(0, player.userData.speed);

            if(player.userData.speed > 0.005) {
                const turn = (keys['a'] ? 1 : 0) - (keys['d'] ? 1 : 0);
                player.userData.angle += turn * 0.04 * (speedKmh > 250 ? 0.4 : 0.8);
            }
            player.rotation.y = player.userData.angle;
            player.translateZ(player.userData.speed);

            checkLap(player);

            // IA Physics
            cars.forEach(ai => {
                if(ai.userData.finished) return;
                const curA = Math.atan2(ai.position.z, ai.position.x);
                const nextA = curA + 0.038;
                const r = TRACK_RADIUS + ai.userData.lane;
                ai.lookAt(Math.cos(nextA)*r, 0, Math.sin(nextA)*r);
                ai.translateZ(1.0 + (Math.random()*0.1));
                checkLap(ai);
            });

            document.getElementById('speedTxt').innerText = Math.floor(player.userData.speed * 320);
            document.getElementById('gearTxt').innerText = currentGear;
        }

        function checkLap(car) {
            const angle = Math.atan2(car.position.z, car.position.x);
            // Detecta passagem pela linha (ângulo cruza de negativo para positivo em X+)
            if(car.userData.lastAngle < 0 && angle >= 0) {
                car.userData.laps++;
                if(car.userData.isPlayer) {
                    document.getElementById('lapTxt').innerText = Math.min(car.userData.laps + 1, maxLaps);
                }
                if(car.userData.laps >= maxLaps && !car.userData.finished) {
                    car.userData.finished = true;
                    finishOrder.push(car.userData.name);
                    if(car.userData.isPlayer) endRace();
                }
            }
            car.userData.lastAngle = angle;
        }

        function endRace() {
            raceStatus = 'finished';
            const podium = document.getElementById('podium');
            podium.innerHTML = "<h3>RESULTADOS:</h3>";
            finishOrder.slice(0, 5).forEach((name, i) => {
                podium.innerHTML += `<p>${i+1}º - ${name}</p>`;
            });
            document.getElementById('results-screen').style.display = 'flex';
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if(player) {
                const camPos = new THREE.Vector3(0, 3.5, -12).applyMatrix4(player.matrixWorld);
                camera.position.lerp(camPos, 0.1);
                camera.lookAt(player.position.x, 1.2, player.position.z);
            }
            renderer.render(scene, camera);
        }

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
        window.startGame = startGame;
    </script>
</body>
</html>
